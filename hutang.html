<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Hutang (Piutang)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for suggestions */
        #suggestions-container::-webkit-scrollbar {
            width: 8px;
        }
        #suggestions-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #suggestions-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #suggestions-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen bg-gray-200">
        <!-- Sidebar akan dimuat di sini -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="flex justify-between items-center p-4 bg-white border-b">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="text-gray-500 focus:outline-none focus:text-gray-700 md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="header-title" class="text-xl font-semibold ml-3">Riwayat Hutang (Piutang)</h1>
                </div>
                <div></div>
            </header>
            <main class="flex-grow overflow-x-hidden bg-gray-100 p-6">
                <div class="container mx-auto">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">Total Hutang Pelanggan (Piutang)</h2>
                        <p class="text-3xl font-bold text-indigo-600" id="final-balance">Memuat...</p>
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-6xl mx-auto">
                        <h2 class="text-xl font-semibold mb-4">Riwayat Transaksi Hutang</h2>
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="flex-grow">
                                <label for="search-hutang" class="sr-only">Cari Transaksi</label>
                                <input type="text" id="search-hutang" placeholder="Cari berdasarkan keterangan, jenis, atau pelanggan..." class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="filter-pelanggan" class="sr-only">Filter berdasarkan pelanggan</label>
                                <select id="filter-pelanggan" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="">Semua Pelanggan</option>
                                    <!-- Opsi akan diisi oleh JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto hidden md:block">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelanggan</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Transaksi</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pemasukan (Rp)</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Data akan dimuat di sini oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Tampilan Card Mobile -->
                        <div id="history-card-body" class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:hidden">
                            <!-- Kartu data akan diisi oleh JavaScript -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script src="main.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Logika spesifik untuk halaman hutang

            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx59LDYtuFqRh6P0a0xtd3usgDpFxXktJbS_jHzbZiai0tqsm3zTIkJSOSFTY1BtfCeqw/exec';
            const BALANCE_NAME = 'Hutang'; // Nama saldo yang akan dilacak

            let allCombinedHistory = [];
            let allPelanggan = new Set();

            async function sendDataToSheet(action, payload, sheetName) {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify({ action, payload, sheetName: sheetName })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            }

            function formatToRupiahDisplay(amount) {
                return `Rp ${amount.toLocaleString('id-ID')}`;
            }

            function renderHistory(historyToRender) {
                const tableBody = document.getElementById('history-table-body');
                const historyCardBody = document.getElementById('history-card-body');
                const finalBalanceEl = document.getElementById('final-balance');

                tableBody.innerHTML = '';
                historyCardBody.innerHTML = '';
                let currentBalance = 0;

                if (historyToRender.length === 0) {
                    const searchInput = document.getElementById('search-hutang').value;
                    const pelangganFilter = document.getElementById('filter-pelanggan').value;
                    const message = (searchInput || pelangganFilter) ? 'Tidak ada data yang cocok dengan filter.' : 'Belum ada riwayat transaksi hutang.';
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">${message}</td></tr>`;
                    historyCardBody.innerHTML = `<div class="text-center py-4 text-gray-500 col-span-full">${message}</div>`;
                } else {
                    historyToRender.forEach(item => {
                        currentBalance += item.pemasukan;
                        currentBalance -= item.pengeluaran;

                        const tanggalFormatted = item.tanggal.toLocaleString('id-ID', {
                            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        });

                        // Untuk Tabel Desktop
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${tanggalFormatted}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${item.pelanggan}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.jenis}</td>
                            <td class="px-4 py-4 text-sm text-gray-500">${item.keterangan}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-green-600">${formatToRupiahDisplay(item.pemasukan)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-red-600">${formatToRupiahDisplay(item.pengeluaran)}</td>
                        `;
                        tableBody.appendChild(row);

                        // Untuk Tampilan Card Mobile
                        const card = document.createElement('div');
                        card.className = 'bg-white border border-gray-200 rounded-lg shadow-sm p-4 space-y-2';
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-gray-800">${item.jenis}</span>
                                <span class="text-xs text-gray-500">${tanggalFormatted}</span>
                            </div>
                            <p class="font-semibold text-gray-700">${item.pelanggan}</p>
                            <p class="text-sm text-gray-600">${item.keterangan}</p>
                            <div class="pt-2 border-t border-gray-100 flex justify-between items-center">
                                <span class="text-lg font-semibold ${item.pemasukan > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${item.pemasukan > 0 ? formatToRupiahDisplay(item.pemasukan) : formatToRupiahDisplay(item.pengeluaran)}
                                </span>
                            </div>
                        `;
                        historyCardBody.appendChild(card);
                    });
                }
                finalBalanceEl.textContent = formatToRupiahDisplay(currentBalance);
            }

            function populatePelangganFilter() {
                const filterSelect = document.getElementById('filter-pelanggan');
                const currentValue = filterSelect.value;
                filterSelect.innerHTML = '<option value="">Semua Pelanggan</option>';
                
                const sortedPelanggan = Array.from(allPelanggan).sort((a, b) => a.localeCompare(b));

                sortedPelanggan.forEach(pelanggan => {
                    if (pelanggan && pelanggan !== 'N/A') {
                        const option = document.createElement('option');
                        option.value = pelanggan;
                        option.textContent = pelanggan;
                        filterSelect.appendChild(option);
                    }
                });
                filterSelect.value = currentValue;
            }

            function applyFiltersAndRender() {
                const searchTerm = document.getElementById('search-hutang').value.toLowerCase();
                const selectedPelanggan = document.getElementById('filter-pelanggan').value;

                let filteredHistory = allCombinedHistory.filter(item => {
                    const pelangganMatch = !selectedPelanggan || item.pelanggan === selectedPelanggan;
                    const searchMatch = !searchTerm || item.keterangan.toLowerCase().includes(searchTerm) || item.jenis.toLowerCase().includes(searchTerm) || item.pelanggan.toLowerCase().includes(searchTerm);
                    return pelangganMatch && searchMatch;
                });
                renderHistory(filteredHistory);
            }

            async function loadAndDisplayHistory() {
                const tableBody = document.getElementById('history-table-body');
                const historyCardBody = document.getElementById('history-card-body');
                const finalBalanceEl = document.getElementById('final-balance');
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Memuat data riwayat...</td></tr>`;
                historyCardBody.innerHTML = `<div class="text-center py-4 text-gray-500 col-span-full">Memuat data riwayat...</div>`;
                finalBalanceEl.textContent = 'Memuat...';

                try {
                    // Selalu ambil data terbaru dari Google Sheets secara paralel
                    const [resultPulsa, resultAkrab, resultTopup] = await Promise.all([
                        sendDataToSheet('read', {}, 'pulsa'),
                        sendDataToSheet('read', {}, 'paket_akrab'),
                        sendDataToSheet('read', {}, 'topup')
                    ]);

                    // Proses dan normalisasi data untuk memastikan nama properti konsisten
                    const transaksiPulsa = (resultPulsa.status === 'success' && Array.isArray(resultPulsa.data))
                        ? resultPulsa.data.map(tx => ({
                            tanggal: tx.tanggal || tx.Tanggal,
                            nomor: tx.nomor || tx.Nomor,
                            nama_pulsa: tx.nama_pulsa || tx['Nama Pulsa'],
                            harga: tx.harga || tx.Harga || 0,
                            pembayaran: tx.pembayaran || tx.Pembayaran,
                            pelanggan: tx.pelanggan || tx.Pelanggan
                        }))
                        : [];

                    const pelangganAkrab = (resultAkrab.status === 'success' && Array.isArray(resultAkrab.data))
                        ? resultAkrab.data.map(p => ({
                            tanggal: p.tanggal_ditambahkan || p.tanggalditambahkan,
                            nama: p.nama,
                            nomor: p.nomor,
                            metodePembayaran: p.metode_pembayaran || p.metodePembayaran,
                            harga: p.harga || 0,
                            pelanggan: p.nama // Di sheet akrab, nama adalah pelanggan
                        }))
                        : [];

                    const dataTopup = (resultTopup.status === 'success' && Array.isArray(resultTopup.data))
                        ? resultTopup.data.map(t => ({ ...t, modal: t.modal || 0, biaya_admin: t.biaya_admin || 0 }))
                        : [];

                    let combinedHistory = [];

                    // Transaksi Pulsa (jika pembayaran adalah Hutang, maka menambah piutang)
                    transaksiPulsa.forEach(tx => {
                        const harga = tx.harga;
                        if (tx.pembayaran === BALANCE_NAME) {
                            const pelanggan = (tx.pelanggan || 'N/A').trim();
                            combinedHistory.push({ tanggal: new Date(tx.tanggal), pelanggan: pelanggan, jenis: 'Pulsa', keterangan: `Penjualan ${tx.nama_pulsa} (${tx.nomor})`, pemasukan: harga, pengeluaran: 0 });
                            allPelanggan.add(pelanggan);
                        }
                    });

                    // Transaksi Paket Akrab (jika metode pembayaran adalah Hutang, maka menambah piutang)
                    pelangganAkrab.forEach(p => {
                        const harga = p.harga;
                        if (p.metodePembayaran === BALANCE_NAME) {
                            const pelanggan = (p.pelanggan || 'N/A').trim();
                            combinedHistory.push({ tanggal: new Date(p.tanggal), pelanggan: pelanggan, jenis: 'Paket Akrab', keterangan: `Penjualan Paket Akrab (${p.nomor})`, pemasukan: harga, pengeluaran: 0 });
                            allPelanggan.add(pelanggan);
                        }
                    });

                    // Baris-baris berikut dikomentari untuk menghilangkan data pembayaran hutang dari riwayat
                    // dataTopup.forEach(topup => {
                    //     const modal = topup.modal;
                    //     if (topup.tujuan_saldo === BALANCE_NAME) {
                    //         const pelanggan = (topup.keterangan || 'N/A').trim();
                    //         combinedHistory.push({ tanggal: new Date(topup.tanggal), pelanggan: pelanggan, jenis: 'Pembayaran Hutang', keterangan: `Pembayaran dari ${topup.sumber_modal}`, pemasukan: 0, pengeluaran: modal });
                    //         allPelanggan.add(pelanggan);
                    //     }
                    // });

                    // Urutkan riwayat berdasarkan tanggal terbaru
                    allCombinedHistory = combinedHistory.sort((a, b) => b.tanggal - a.tanggal);

                    populatePelangganFilter();
                    applyFiltersAndRender();

                } catch (error) {
                    console.error("Gagal memuat riwayat:", error);
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat data. Coba lagi.</td></tr>`;
                    historyCardBody.innerHTML = `<div class="text-center py-4 text-red-500 col-span-full">Gagal memuat data. Coba lagi.</div>`;
                    finalBalanceEl.textContent = 'Error';
                }
            }

            document.getElementById('search-hutang').addEventListener('input', applyFiltersAndRender);
            document.getElementById('filter-pelanggan').addEventListener('change', applyFiltersAndRender);

            loadAndDisplayHistory();
        });
    </script>
</body>
</html>
