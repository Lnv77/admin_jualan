<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Paket Akrab</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100svh; /* Gunakan svh agar address bar sembunyi saat scroll di mobile portrait */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen bg-gray-200">
        <!-- Sidebar will be loaded here -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="flex justify-between items-center p-4 bg-white border-b">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="text-gray-500 focus:outline-none focus:text-gray-700 md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="header-title" class="text-xl font-semibold ml-3">Input Paket Akrab</h1>
                </div>
                <div></div>
            </header>
            <main class="flex-grow overflow-x-hidden bg-gray-100 p-6">
                <div class="container mx-auto">
                    
                    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl mx-auto">
                        <form id="form-paket-akrab">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal Transaksi</label>
                                    <input type="date" id="tanggal" name="tanggal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="nama_pelanggan" class="block text-sm font-medium text-gray-700">Nama Pelanggan</label>
                                    <input type="text" id="nama_pelanggan" name="nama_pelanggan" placeholder="Contoh: Budi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="masa_aktif" class="block text-sm font-medium text-gray-700">Tanggal Masa Aktif</label>
                                    <input type="date" id="masa_aktif" name="masa_aktif" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="no_hp" class="block text-sm font-medium text-gray-700">No. HP</label>
                                    <input type="tel" id="no_hp" name="no_hp" placeholder="081234567890" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="modal" class="block text-sm font-medium text-gray-700">Modal (Rp)</label>
                                    <input type="text" inputmode="numeric" id="modal" name="modal" placeholder="60.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="harga" class="block text-sm font-medium text-gray-700">Harga Jual (Rp)</label>
                                    <input type="text" inputmode="numeric" id="harga" name="harga" placeholder="65.000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="sumber_modal" class="block text-sm font-medium text-gray-700">Sumber Modal</label>
                                    <select id="sumber_modal" name="sumber_modal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="Agen Pulsa">Agen Pulsa</option>
                                        <option value="DANA">DANA</option>
                                        <option value="GoPay">GoPay</option>
                                        <option value="ShopeePay">ShopeePay</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="pembayaran" class="block text-sm font-medium text-gray-700">Metode Pembayaran</label>
                                    <select id="pembayaran" name="pembayaran" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="Cash">Cash</option>
                                        <option value="Hutang">Hutang</option>
                                        <option value="Agen Pulsa">Agen Pulsa</option>
                                        <option value="DANA">DANA</option>
                                        <option value="GoPay">GoPay</option>
                                        <option value="ShopeePay">ShopeePay</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="link_akun" class="block text-sm font-medium text-gray-700">Link Akun</label>
                                    <input type="text" id="link_akun" name="link_akun" placeholder="Teks atau link..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="no_wallet" class="block text-sm font-medium text-gray-700">No. Wallet</label>
                                    <input type="text" id="no_wallet" name="no_wallet" placeholder="Nomor DANA/GoPay/dll." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Simpan Transaksi
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="container mx-auto mt-8">
                        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-6xl mx-auto">
                            <h2 class="text-xl font-semibold mb-4">Data Transaksi Paket Akrab</h2>
                            <div class="mb-4">
                                <input type="text" id="search-input" placeholder="Cari berdasarkan ID, No. HP, atau Pelanggan..." class="block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="overflow-x-auto hidden md:block">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelanggan</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. HP</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masa Aktif</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Jual</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pembayaran</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                            <div id="card-body" class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:hidden"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Detail -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Detail Transaksi</h3>
        <div id="modal-content" class="mt-4 px-2 py-3 text-sm text-gray-800 space-y-2"></div>
        <div class="items-center px-4 py-3">
          <button id="modal-close-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">Tutup</button>
        </div>
      </div>
    </div>

    <!-- Modal Edit -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Edit Transaksi Paket Akrab</h3>
            <form id="form-edit">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-tanggal" class="block text-sm font-medium text-gray-700">Tanggal Transaksi</label>
                        <input type="date" id="edit-tanggal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="edit-nama_pelanggan" class="block text-sm font-medium text-gray-700">Nama Pelanggan</label>
                        <input type="text" id="edit-nama_pelanggan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="edit-no_hp" class="block text-sm font-medium text-gray-700">No. HP</label>
                        <input type="tel" id="edit-no_hp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="edit-masa_aktif" class="block text-sm font-medium text-gray-700">Tanggal Masa Aktif</label>
                        <input type="date" id="edit-masa_aktif" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="edit-modal-input" class="block text-sm font-medium text-gray-700">Modal (Rp)</label>
                        <input type="text" inputmode="numeric" id="edit-modal-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="edit-harga" class="block text-sm font-medium text-gray-700">Harga Jual (Rp)</label>
                        <input type="text" inputmode="numeric" id="edit-harga" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="edit-sumber_modal" class="block text-sm font-medium text-gray-700">Sumber Modal</label>
                        <select id="edit-sumber_modal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="Agen Pulsa">Agen Pulsa</option>
                            <option value="DANA">DANA</option>
                            <option value="GoPay">GoPay</option>
                            <option value="ShopeePay">ShopeePay</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-pembayaran" class="block text-sm font-medium text-gray-700">Metode Pembayaran</label>
                        <select id="edit-pembayaran" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="Cash">Cash</option>
                            <option value="Hutang">Hutang</option>
                            <option value="Agen Pulsa">Agen Pulsa</option>
                            <option value="DANA">DANA</option>
                            <option value="GoPay">GoPay</option>
                            <option value="ShopeePay">ShopeePay</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit-link_akun" class="block text-sm font-medium text-gray-700">Link Akun</label>
                        <input type="text" id="edit-link_akun" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit-no_wallet" class="block text-sm font-medium text-gray-700">No. Wallet</label>
                        <input type="text" id="edit-no_wallet" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="edit-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">Batal</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <script src="main.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // =================================================================
            // KODE DI BAWAH INI HANYA UNTUK LOGIKA SPESIFIK HALAMAN PAKET AKRAB
            // =================================================================
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx59LDYtuFqRh6P0a0xtd3usgDpFxXktJbS_jHzbZiai0tqsm3zTIkJSOSFTY1BtfCeqw/exec';
            const SHEET_NAME = 'paket_akrab';

            // --- ELEMEN DOM ---
            const form = document.getElementById('form-paket-akrab');
            const tableBody = document.getElementById('table-body');
            const cardBody = document.getElementById('card-body');
            const searchInput = document.getElementById('search-input');
            const detailModal = document.getElementById('detail-modal');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('form-edit');
            const editCancelBtn = document.getElementById('edit-cancel-btn');

            let allTransactions = [];

            // --- FUNGSI MAPPING DATA ---
            function mapTransaction(tx) {
                const cleanString = (str) => (typeof str === 'string' ? str.trim().replace(/^"|"$/g, '') : str);
                return {
                    id: tx.id,
                    tanggal: tx.tanggal_ditambahkan || tx.tanggal,
                    nama_pelanggan: cleanString(tx.nama || tx.nama_pelanggan),
                    nomor: tx.nomor,
                    masa_aktif: cleanString(tx['masa aktif']),
                    modal: tx.modal,
                    harga: tx.harga,
                    pembayaran: cleanString(tx.metode_pembayaran || tx.pembayaran),
                    sumber_modal: cleanString(tx['sumber modal'] || tx.sumber_modal),
                    link_akun: cleanString(tx.link_akun),
                    no_wallet: cleanString(tx.no_wallet)
                };
            }

            // --- FUNGSI HELPER ---
            const formatRupiah = (e) => {
                const input = e.target;
                let numericValue = input.value.replace(/\D/g, '');
                input.value = numericValue ? new Intl.NumberFormat('id-ID').format(numericValue) : '';
            };
            const parseRupiah = (value) => parseInt(String(value || '').replace(/\D/g, ''), 10) || 0;
            const setInitialDate = (elementId) => {
                const input = document.getElementById(elementId);
                if (!input) return;
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                input.value = now.toISOString().slice(0, 10);
            };
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                // Handle YYYY-MM-DD strings by treating them as local, not UTC
                const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00');
                return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            };
            const toInputDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            };
            async function sendDataToSheet(action, payload) {
                const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action, payload, sheetName: SHEET_NAME }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            };

            const updateMasaAktif = (tanggalId, masaAktifId) => {
                const tanggalEl = document.getElementById(tanggalId);
                const masaAktifEl = document.getElementById(masaAktifId);
                if (!tanggalEl || !masaAktifEl) return;

                const tanggalValue = tanggalEl.value;
                if (tanggalValue) {
                    const startDate = new Date(tanggalValue + 'T00:00:00');
                    startDate.setDate(startDate.getDate() + 30);
                    masaAktifEl.value = startDate.toISOString().slice(0, 10);
                } else {
                    masaAktifEl.value = '';
                }
            }

            // --- RENDER DATA ---
            function renderData(transactions) {
                tableBody.innerHTML = '';
                cardBody.innerHTML = '';
                const searchQuery = searchInput.value.toLowerCase().trim();
                const filtered = transactions.filter(tx => {
                    if (!searchQuery) return true;
                    return Object.values(tx).some(val => String(val).toLowerCase().includes(searchQuery));
                });

                if (filtered.length === 0) {
                    const message = searchQuery ? `Tidak ada data yang cocok dengan pencarian "${searchQuery}".` : 'Belum ada data transaksi.';
                    tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">${message}</td></tr>`;
                    cardBody.innerHTML = `<div class="text-center py-4 text-gray-500 col-span-full">${message}</div>`;
                    return;
                }

                filtered.forEach(tx => {
                    const harga = tx.harga || 0;
                    const tanggalFormatted = formatDate(tx.tanggal);
                    const masaAktifFormatted = formatDate(tx.masa_aktif);
                    
                    // Tabel Desktop
                    tableBody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 text-sm font-medium text-gray-900">${tx.id}</td>
                            <td class="px-4 py-4 text-sm text-gray-900">${tanggalFormatted}</td>
                            <td class="px-4 py-4 text-sm text-gray-500">${tx.nama_pelanggan || 'N/A'}</td>
                            <td class="px-4 py-4 text-sm text-gray-500">${tx.nomor || 'N/A'}</td>
                            <td class="px-4 py-4 text-sm text-gray-500">${masaAktifFormatted}</td>
                            <td class="px-4 py-4 text-sm text-gray-500">Rp ${harga.toLocaleString('id-ID')}</td>
                            <td class="px-4 py-4 text-sm text-gray-500">${tx.pembayaran || ''}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-2 rounded-md js-detail-btn" data-id="${tx.id}">Detail</button>
                                <button class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold py-1 px-2 rounded-md ml-2 js-edit-btn" data-id="${tx.id}">Edit</button>
                                <button class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-md ml-2 js-delete-btn" data-id="${tx.id}">Hapus</button>
                            </td>
                        </tr>`;

                    // Card Mobile
                    cardBody.innerHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-gray-800">${tx.nama_pelanggan || 'Nama Pelanggan'}</span>
                                <span class="text-xs bg-indigo-100 text-indigo-800 font-medium px-2 py-0.5 rounded">ID: ${tx.id}</span>
                            </div>
                            <p class="text-sm text-gray-600">${tx.nomor}</p>
                            <p class="text-sm text-gray-600">${tanggalFormatted}</p>
                            <div class="pt-2 border-t flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-800">Rp ${harga.toLocaleString('id-ID')}</span>
                                <div class="flex space-x-2">
                                    <button class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-2 rounded-md js-detail-btn" data-id="${tx.id}">Detail</button>
                                    <button class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold py-1 px-2 rounded-md js-edit-btn" data-id="${tx.id}">Edit</button>
                                    <button class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-md js-delete-btn" data-id="${tx.id}">Hapus</button>
                                </div>
                            </div>
                        </div>`;
                });
            }

            // --- EVENT HANDLERS ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Menyimpan...';

                const nomorValue = document.getElementById('no_hp').value;
                const noWalletValue = document.getElementById('no_wallet').value;
                const linkAkunValue = document.getElementById('link_akun').value;
                const payload = {
                    id: `akrab-${Math.floor(1000 + Math.random() * 9000)}`,
                    tanggal_ditambahkan: document.getElementById('tanggal').value,
                    // Prepend single quote to force string type in Google Sheets
                    nomor: nomorValue ? `'${nomorValue}` : '',
                    nama: document.getElementById('nama_pelanggan').value,
                    'masa aktif': document.getElementById('masa_aktif').value,
                    modal: parseRupiah(document.getElementById('modal').value),
                    harga: parseRupiah(document.getElementById('harga').value),
                    'sumber modal': document.getElementById('sumber_modal').value,
                    metode_pembayaran: document.getElementById('pembayaran').value,
                    link_akun: linkAkunValue,
                    // Prepend single quote to force string type in Google Sheets
                    no_wallet: noWalletValue ? `'${noWalletValue}` : '',
                };

                try {
                    const result = await sendDataToSheet('create', payload);
                    if (result.status === 'success') {
                        alert('Transaksi berhasil disimpan.');
                        form.reset();
                        setInitialDate('tanggal');
                        loadInitialData();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    alert('Gagal menyimpan data: ' + error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Simpan Transaksi';
                }
            });

            async function handleActions(e) {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                const tx = allTransactions.find(t => t.id == id);
                if (!tx) return;

                if (target.classList.contains('js-detail-btn')) {
                    modalContent.innerHTML = `
                        <p><strong>ID:</strong> ${tx.id}</p>
                        <p><strong>Tanggal Transaksi:</strong> ${formatDate(tx.tanggal)}</p>
                        <p><strong>Nama Pelanggan:</strong> ${tx.nama_pelanggan || ''}</p>
                        <p><strong>No. HP:</strong> ${tx.nomor || ''}</p>
                        <p><strong>Tanggal Masa Aktif:</strong> ${formatDate(tx.masa_aktif)}</p>
                        <p><strong>Modal:</strong> Rp ${parseRupiah(tx.modal).toLocaleString('id-ID')}</p>
                        <p><strong>Harga Jual:</strong> Rp ${parseRupiah(tx.harga).toLocaleString('id-ID')}</p>
                        <p><strong>Sumber Modal:</strong> ${tx.sumber_modal || ''}</p>
                        <p><strong>Metode Pembayaran:</strong> ${tx.pembayaran || ''}</p>
                        <p><strong>Link Akun:</strong> ${tx.link_akun ? `<a href="${tx.link_akun}" target="_blank" class="text-indigo-600 hover:underline">${tx.link_akun}</a>` : ''}</p>
                        <p><strong>No. Wallet:</strong> ${tx.no_wallet || ''}</p>
                    `;
                    detailModal.classList.remove('hidden');
                }

                if (target.classList.contains('js-edit-btn')) {
                    document.getElementById('edit-id').value = tx.id;
                    document.getElementById('edit-tanggal').value = toInputDate(tx.tanggal);
                    document.getElementById('edit-nama_pelanggan').value = tx.nama_pelanggan || '';
                    document.getElementById('edit-no_hp').value = tx.nomor || '';
                    updateMasaAktif('edit-tanggal', 'edit-masa_aktif');
                    document.getElementById('edit-modal-input').value = parseRupiah(tx.modal).toLocaleString('id-ID');
                    document.getElementById('edit-harga').value = parseRupiah(tx.harga).toLocaleString('id-ID');
                    document.getElementById('edit-sumber_modal').value = tx.sumber_modal || '';
                    document.getElementById('edit-pembayaran').value = tx.pembayaran || '';
                    document.getElementById('edit-link_akun').value = tx.link_akun || '';
                    document.getElementById('edit-no_wallet').value = tx.no_wallet || '';
                    editModal.classList.remove('hidden');
                }

                if (target.classList.contains('js-delete-btn')) {
                    if (confirm(`Yakin ingin menghapus transaksi untuk "${tx.nama_pelanggan}"?`)) {
                        try {
                            target.disabled = true;
                            const result = await sendDataToSheet('delete', { id });
                            if (result.status === 'success') {
                                alert('Data berhasil dihapus.');
                                loadInitialData();
                            } else { throw new Error(result.message); }
                        } catch (error) {
                            alert('Gagal menghapus data: ' + error.message);
                            target.disabled = false;
                        }
                    }
                }
            }

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = editForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Menyimpan...';

                const nomorValue = document.getElementById('edit-no_hp').value;
                const noWalletValue = document.getElementById('edit-no_wallet').value;
                const linkAkunValue = document.getElementById('edit-link_akun').value;
                const payload = {
                    id: document.getElementById('edit-id').value,
                    tanggal_ditambahkan: document.getElementById('edit-tanggal').value,
                    // Prepend single quote to force string type in Google Sheets
                    nomor: nomorValue ? `'${nomorValue}` : '',
                    nama: document.getElementById('edit-nama_pelanggan').value,
                    'masa aktif': document.getElementById('edit-masa_aktif').value,
                    modal: parseRupiah(document.getElementById('edit-modal-input').value),
                    harga: parseRupiah(document.getElementById('edit-harga').value),
                    'sumber modal': document.getElementById('edit-sumber_modal').value,
                    metode_pembayaran: document.getElementById('edit-pembayaran').value,
                    link_akun: linkAkunValue,
                    // Prepend single quote to force string type in Google Sheets
                    no_wallet: noWalletValue ? `'${noWalletValue}` : '',
                };

                try {
                    const result = await sendDataToSheet('update', payload);
                    if (result.status === 'success') {
                        alert('Data berhasil diperbarui.');
                        editModal.classList.add('hidden');
                        loadInitialData();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    alert('Gagal memperbarui data: ' + error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Simpan Perubahan';
                }
            });

            // --- MEMUAT DATA AWAL ---
            async function loadInitialData() {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">Memuat data...</td></tr>`;
                cardBody.innerHTML = `<div class="text-center py-4 text-gray-500 col-span-full">Memuat data...</div>`;
                try {
                    const response = await sendDataToSheet('read', {});
                    const rawData = response.data || response;
                    allTransactions = Array.isArray(rawData) ? rawData.map(mapTransaction) : [];
                    renderData(allTransactions);
                } catch (error) {
                    const message = "Gagal memuat data. Coba muat ulang halaman.";
                    tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">${message}</td></tr>`;
                    cardBody.innerHTML = `<div class="text-center py-4 text-red-500 col-span-full">${message}</div>`;
                }
            }

            // --- INISIALISASI ---
            ['modal', 'harga', 'edit-modal-input', 'edit-harga'].forEach(id => document.getElementById(id).addEventListener('input', formatRupiah));
            document.getElementById('tanggal').addEventListener('change', () => updateMasaAktif('tanggal', 'masa_aktif'));
            document.getElementById('edit-tanggal').addEventListener('change', () => updateMasaAktif('edit-tanggal', 'edit-masa_aktif'));
            tableBody.addEventListener('click', handleActions);
            cardBody.addEventListener('click', handleActions);
            searchInput.addEventListener('input', () => renderData(allTransactions));
            modalCloseBtn.addEventListener('click', () => detailModal.classList.add('hidden'));
            editCancelBtn.addEventListener('click', () => editModal.classList.add('hidden'));

            setInitialDate('tanggal');
            updateMasaAktif('tanggal', 'masa_aktif');
            loadInitialData();
        });
    </script>
</body>
</html>
